!function(t){"use strict";function e(e,i){function n(t){function e(t){switch(t){case L.DONE_FILE_LOADING:i("Click somewhere to start a line. (ensure legend is correct, if not click 'calibrate')");break;case L.DONE_START_LINE:i("A second click finishes the line. Or Cancel with 'Esc'.");break;case L.DONE_FINISH_LINE:i("TIP: starting a line where another ends measures their angles.");break;case L.DONE_ADD_ANGLE:i("Double click on center of line to set relative size.");break;case L.DONE_SET_LEN:i("Congratulations - you are an expert now!",!0)}}function i(e,i){if(void 0!=e){for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e)),void 0!=i&&i&&(t.style.transition="opacity 10s",t.style.opacity=0)}}this.last_help_level_=-1,i("(Only your browser reads the image. It is not uploaded anywhere.)"),this.achievementUnlocked=function(t){t<this.last_help_level_||(this.last_help_level_=t,e(t))},this.gridSizeHelp=function(){i("Click to draw a box around the large box in the grid (200ms by 5mm (0.5 mV)")},this.hideHelp=function(){i("")}}function a(t,e,i,n){return Math.sqrt((i-t)*(i-t)+(n-e)*(n-e))}function r(t,e){this.update=function(t,e){this.x=t,this.y=e},this.get_key=function(){return this.x+":"+this.y},this.update(t,e)}function s(t,e,i,n){this.p1=new r(t+.5,e+.5),this.p2=new r(i+.5,n+.5),this.updatePos=function(t,e){this.p2.update(t+.5,e+.5)},this.distanceToCenter=function(t,e){return a((this.p1.x+this.p2.x)/2,(this.p1.y+this.p2.y)/2,t,e)},this.length=function(){return a(this.p1.x,this.p1.y,this.p2.x,this.p2.y)}}function o(t,e,i){this.center=t,this.p=e,this.line=i,this.angle=void 0,this.is_valid=!1,this.arm_length=function(){return a(this.center.x,this.center.y,this.p.x,this.p.y)},this.notifyPointsChanged=function(){var t=a(this.center.x,this.center.y,this.p.x,this.p.y);if(0!=t){var e=this.p.x-this.center.x,i=Math.acos(e/t);this.p.y>this.center.y&&(i=2*Math.PI-i),this.angle=i,this.is_valid=!0}else this.is_valid=!1},this.notifyPointsChanged()}function h(t,e){this.center=t.center,this.start=t.angle,this.end=e.angle,this.end<this.start&&(this.end+=2*Math.PI),this.max_radius=Math.min(t.arm_length(),e.arm_length())/2,this.angleInDegrees=function(){var t=180*(this.end-this.start)/Math.PI;return t<0&&(t+=360),t}}function l(){function t(t,e){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)}function e(e,i){var n=i.p1,a=i.p2,r=t(n,a);if(0==r)return t(e,n);var s=((e.x-n.x)*(a.x-n.x)+(e.y-n.y)*(a.y-n.y))/r;return s=Math.max(0,Math.min(1,s)),t(e,{x:n.x+s*(a.x-n.x),y:n.y+s*(a.y-n.y)})}this.lines_=new Array,this.point_angle_map_={},this.current_line_=void 0,this.current_angle_=void 0,this.hovered_line_index_=void 0,this.drag_start_point_=void 0,this.drag_line_x1_=void 0,this.drag_line_y1_=void 0,this.drag_line_x2_=void 0,this.drag_line_y2_=void 0,this.really_dragging_=!1,this.startEditLine=function(t,e){var i=Math.round(A.canvasWidthToImageWidth(t)),n=Math.round(A.canvasHeightToImageHeight(e)),a=new s(i,n,i,n);if(this.current_line_=a,this.current_angle_=this.addAngle(a.p1,a.p2,a),void 0!==this.hovered_line_index_){this.really_dragging_=null,this.drag_start_point_=new r(t,e);a=this.lines_[this.hovered_line_index_];this.drag_line_x1_=a.p1.x,this.drag_line_y1_=a.p1.y,this.drag_line_x2_=a.p2.x,this.drag_line_y2_=a.p2.y}},this.hasEditLine=function(){return void 0!=this.current_line_},this.getEditLine=function(){return this.current_line_},this.updateEditLine=function(t,e){if(void 0!==this.drag_start_point_){var i=t-this.drag_start_point_.x,n=e-this.drag_start_point_.y;if(-1<i&&i<1&&-1<n&&n<1);else{this.forgetEditLine(),this.really_dragging_=!0;var a=this.lines_[this.hovered_line_index_];this.removeAngle(a.p1,a),this.removeAngle(a.p2,a),this.updateDrag(t,e)}}if(void 0!=this.current_line_){var r=Math.round(A.canvasWidthToImageWidth(t)),s=Math.round(A.canvasHeightToImageHeight(e));return this.current_line_.updatePos(r,s),this.current_angle_.notifyPointsChanged(),this.current_line_}},this.commitEditLine=function(){var t=this.current_line_;this.lines_[this.lines_.length]=t,this.addAngle(t.p2,t.p1,t),this.current_line_=void 0},this.forgetEditLine=function(){void 0!=this.current_line_&&(this.removeAngle(this.current_line_.p1,this.current_line_),this.current_line_=void 0)},this.updateDrag=function(t,e){if(this.isDragging()){var i=t-this.drag_start_point_.x,n=e-this.drag_start_point_.y,a=this.lines_[this.hovered_line_index_],r=Math.round(A.canvasWidthToImageWidth(i)),s=Math.round(A.canvasHeightToImageHeight(n));a.p1.x=this.drag_line_x1_+r,a.p1.y=this.drag_line_y1_+s,a.p2.x=this.drag_line_x2_+r,a.p2.y=this.drag_line_y2_+s}},this.endDrag=function(){if(void 0!==this.drag_start_point_){if(this.really_dragging_){var t=this.lines_[this.hovered_line_index_];this.addAngle(t.p1,t.p2,t),this.addAngle(t.p2,t.p1,t)}this.drag_start_point_=void 0,this.drag_line_x1_=void 0,this.drag_line_y1_=void 0,this.drag_line_x2_=void 0,this.drag_line_y2_=void 0,this.really_dragging_=!1}},this.isDragging=function(){return void 0!==this.drag_start_point_},this.getHoveredLineIndex=function(){return this.hovered_line_index_},this.updateHoveredLine=function(t,i){for(var n,a=new r(A.canvasWidthToImageWidth(t+.5),A.canvasWidthToImageWidth(i+.5)),s=this.lines_.length,o=0;o<s;++o){var h=this.lines_[o],l=e(a,h);if((l=A.imageWidthToCanvasWidth(l))<=4&&(n=o),h.textBoundingBox){var d=h.textBoundingBox,u=t+.5,c=i+.5;d.left<u&&u<=d.right&&d.top<=c&&c<=d.bottom&&(n=o)}}return this.hovered_line_index_!==n&&(this.hovered_line_index_=n,!0)},this.addAngle=function(t,e,i){var n=t.get_key(),a=this.point_angle_map_[n];void 0===a&&(a=new Array,this.point_angle_map_[n]=a);var r=new o(t,e,i);return a[a.length]=r,r},this.removeAngle=function(t,e){var i=t.get_key(),n=this.point_angle_map_[i];if(void 0!==n){for(var a=-1,r=0;r<n.length;++r)if(n[r].line==e){a=r;break}a>=0&&n.splice(a,1)}},this.removeLine=function(t){var e=this.lines_.indexOf(t);e<0&&alert("Should not happen: Removed non-existent line"),this.lines_.splice(e,1)},this.removeAllLines=function(){this.lines_=new Array,this.point_angle_map_={},this.current_line_=void 0,this.current_angle_=void 0,this.hovered_line_index_=void 0,this.drag_start_point_=void 0,this.drag_line_x1_=void 0,this.drag_line_y1_=void 0,this.drag_line_x2_=void 0,this.drag_line_y2_=void 0,this.really_dragging_=!1},this.findClosest=function(t,e){var i=void 0,n=void 0;if(this.forAllLines(function(a){var r=a.distanceToCenter(t,e);(void 0==i||r<i)&&(i=r,n=a)}),n&&i<50)return n},this.forAllLines=function(t){for(var e=0;e<this.lines_.length;++e)t(this.lines_[e],e)},this.forAllArcs=function(t){for(var e in this.point_angle_map_)if(this.point_angle_map_.hasOwnProperty(e)){var i=this.point_angle_map_[e];if(!(i.length<2)){i.sort(function(t,e){return t.angle-e.angle});for(var n=0;n<i.length;++n){var a=i[n],r=i[(n+1)%i.length];if(a.is_valid&&r.is_valid){var s=new h(a,r);s.angleInDegrees()>=180||t(s)}}}}}}function d(t,e,i){function n(i){return i*t.width/e}function r(e){return e*t.height/i}function s(t){if(null!==T&&null!==M){var e=200/T,i=5/M;e=n(e),i=r(i),t.fillStyle=P,t.beginPath(),t.moveTo(18.5,18.5),t.lineTo(20.5+e+2,18.5),t.lineTo(20.5+e+2,20.5+i+2),t.lineTo(18.5,20.5+i+2),t.fill(),t.strokeStyle="#f00",t.lineWidth=1,t.lineCap="butt",t.beginPath(),t.moveTo(e+20.5,20.5),t.lineTo(e+20.5,i+20.5),t.stroke(),t.beginPath(),t.moveTo(e+20.5,i+20.5),t.lineTo(20.5,i+20.5),t.stroke(),v(t,"200 ms",e/2+20.5,i+20.5+12,"center"),v(t,"5mm",e+20.5+12,i/2+20.5,"left")}else v(t,"Need calibration",20.5,20.5,"left")}function h(t,e,i,n,a,r){t.save(),t.beginPath(),t.translate(i,n),t.strokeStyle=P,t.lineWidth=H,t.lineCap="butt",t.moveTo(0,0),r<=Math.PI/2||r>3*Math.PI/2?(t.rotate(-r),t.textAlign="right",t.textBaseline="middle",t.lineTo(a,0),t.stroke(),t.fillText(e,a,0)):(t.rotate(-(r+Math.PI)),t.textAlign="left",t.textBaseline="middle",t.lineTo(-a,0),t.stroke(),t.fillText(e,-a,0)),t.restore()}function d(t,e,i){var a=n(e.center.x),s=r(e.center.y),o=n(e.max_radius),l=t.measureText("333.3°").width+2*N+i;t.beginPath(),t.lineWidth=C,t.strokeStyle=P,t.arc(a,s,Math.min(l,o),2*Math.PI-e.end,2*Math.PI-e.start),t.stroke(),t.beginPath(),t.lineWidth=1,t.strokeStyle="#000",t.arc(a,s,Math.min(l,o),2*Math.PI-e.end,2*Math.PI-e.start),t.stroke();var d=(e.end-e.start)/2+e.start;h(t,e.angleInDegrees().toFixed(1)+"°",a,s,l-2,d)}function u(t,e,i,s,o,h,l){var d=a(e=n(e),i=r(i),s=n(s),o=r(o));if(!(d<1)){var u=s-e,c=o-i;void 0===l?(t.moveTo(e-h*c/d,i+h*u/d),t.lineTo(e+h*c/d,i-h*u/d)):(t.moveTo(e-h*c/d,i+h*u/d),t.lineTo(e-l*c/d,i+l*u/d),t.moveTo(e+h*c/d,i-h*u/d),t.lineTo(e+l*c/d,i-l*u/d))}}function c(t){return null===T||null===M?"? mm / ? ms":((t.p1.y-t.p2.y)*M).toPrecision(4)+" mm / "+((t.p2.x-t.p1.x)*T).toPrecision(4)+" ms"}function g(t,e){var i=e.length(),a=e.p2.x-e.p1.x,s=e.p2.y-e.p1.y;if(i>2&&(a=a*(i-2)/i,s=s*(i-2)/i),t.beginPath(),t.strokeStyle=P,t.lineWidth=C,t.lineCap="round",u(t,e.p1.x,e.p1.y,e.p2.x,e.p2.y,N),t.stroke(),t.beginPath(),t.lineCap="butt",t.moveTo(n(e.p1.x),r(e.p1.y)),t.lineTo(n(e.p1.x+a),r(e.p1.y+s)),t.stroke(),t.beginPath(),t.strokeStyle="#000",t.lineWidth=.5,t.lineCap="butt",u(t,e.p1.x,e.p1.y,e.p2.x,e.p2.y,50),u(t,e.p2.x,e.p2.y,e.p1.x,e.p1.y,50,10),t.stroke(),t.beginPath(),t.strokeStyle="#00F",t.lineWidth=2,t.moveTo(n(e.p1.x),r(e.p1.y)),t.lineTo(n(e.p1.x+a),r(e.p1.y+s)),t.stroke(),i>=2){var o=c(e),h=t.measureText(o).width+2*W,l=-h/2,d=-(W+10)/2;i>0&&(l=-a*h/(2*i),d=-s*(W+10)/(2*i)),v(t,o,n(e.p1.x)+l,r(e.p1.y)+d,"center")}}function f(t,e,i,a){var s=c(e);t.beginPath(),t.strokeStyle=a?z:P,t.lineWidth=C,t.lineCap="round",t.moveTo(n(e.p1.x),r(e.p1.y)),t.lineTo(n(e.p2.x),r(e.p2.y)),u(t,e.p1.x,e.p1.y,e.p2.x,e.p2.y,N),u(t,e.p2.x,e.p2.y,e.p1.x,e.p1.y,N),t.stroke(),t.beginPath(),t.strokeStyle=a?D:S,t.lineWidth=2,t.moveTo(n(e.p1.x),r(e.p1.y)),t.lineTo(n(e.p2.x),r(e.p2.y)),u(t,e.p1.x,e.p1.y,e.p2.x,e.p2.y,N),u(t,e.p2.x,e.p2.y,e.p1.x,e.p1.y,N),t.stroke();var h=new o(e.p1,e.p2,e),l=h.angle>0&&h.angle<Math.PI/2||h.angle>Math.PI&&h.angle<3*Math.PI/2,d=Math.PI/10,g=h.angle>0&&h.angle<d||h.angle>Math.PI/2&&h.angle<Math.PI/2+d,_={};v(t,s,n(e.p1.x+e.p2.x)/2,r(e.p1.y+e.p2.y)/2-25,g?"center":l?"right":"left",a,_),e.textBoundingBox=_}function v(t,e,i,n,a,r,s){t.font="bold "+W+"px Sans Serif",t.textBaseline="middle",t.textAlign=a,t.beginPath();var o=t.measureText(e).width,h=W+5;t.lineWidth=h,t.lineCap="round",t.strokeStyle=r?z:P;var l=i;"center"==a?l-=o/2:"right"==a&&(l-=o),t.moveTo(l,n),t.lineTo(l+o,n),t.stroke(),t.fillStyle="#000",t.fillText(e,i,n),s&&(s.left=l-h/2,s.right=l+o+h/2,s.top=n-h/2,s.bottom=n+h/2)}function p(t,e,i){if(e.p1.x!=e.p2.x&&e.p1.y!=e.p2.y){var a=e.p2.y-e.p1.y,s=e.p2.x-e.p1.x;if(t.beginPath(),t.lineWidth=1,t.strokeStyle="#000",t.moveTo(n(e.p1.x),r(e.p1.y)),t.lineTo(n(e.p2.x),r(e.p1.y)),Math.abs(a)>30){var o=r(e.p1.y+a)-(a<0?-30:30);t.lineTo(n(e.p2.x),o)}t.stroke();var h=T*s,l="center";s<=0&&s>-80?l="right":s>=0&&s<80&&(l="left"),v(t,h.toPrecision(4)+" ms",n(e.p1.x+e.p2.x)/2,r(e.p1.y)+(a>0?-20:20),l),v(t,(M*-a).toPrecision(4)+" mm",n(e.p2.x)+(s>0?10:-10),r(e.p1.y+e.p2.y)/2,e.p1.x<e.p2.x?"left":"right")}}this.measure_canvas_=t,this.measure_ctx_=this.measure_canvas_.getContext("2d"),this.model_=void 0,this.controller_=void 0,this.print_factor_=1,this.show_deltas_=!1,this.show_angles_=!0,this.mode_="default";var x,y,b,w,T=null,M=null;this.imageWidthToCanvasWidth=function(t){return n(t)},this.imageHeightToCanvasHeight=function(t){return r(t)},this.canvasWidthToImageWidth=function(i){return i*e/t.width},this.canvasHeightToImageHeight=function(e){return e*i/t.height},this.updateModeIndicators=function(){if("grid_size"===this.mode_?(m.find(".measure").css("cursor","crosshair"),m.find(".specify-grid-size-manually").addClass("active"),m.find(".loupe").show(),k.gridSizeHelp()):(m.find(".specify-grid-size-manually").removeClass("active"),k.hideHelp()),"measuring"===this.mode_){m.find(".measure").css("cursor","url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD8AAAA/CAYAAABXXxDfAAAAsklEQVRoge3USQ6DMBQE0cp0LV+OgzsbllkZ5JbSVZLFCvMfE2Qb4etHE9+a+NbEtya+NfGtiW+tGm9tjTnnAXAeq15/8SBefHierYkH8eLD82xNPIgXH55nubGyfuBXVrY557GyztNfN+xxqdRdfwBv4HnDXhnDxaf2uWGPaL3f/GJ/87dfSTyIFx+eZ2viQbz48DxbEw/ixYfnMdtY9esuvjXxrYlvTXxr4lsT31oU/wX/Qa/XTVwxtAAAAABJRU5ErkJggg==) 31 31, crosshair"),m.find(".loupe").show(),k.achievementUnlocked(L.DONE_FILE_LOADING)}"default"===this.mode_?(m.find(".measure").css("cursor","default"),m.find(".ecg-measure-button").removeClass("active"),m.find(".ecg-controls-2").css("visibility","hidden"),k.hideHelp()):(m.find(".ecg-measure-button").addClass("active"),m.find(".ecg-controls-2").css("visibility","visible")),m.find(".ecg-zoom-button").hasClass("active")||"default"!==this.mode_?m.find(".loupe").show():m.find(".loupe").hide()},this.gridSizeMode=function(){this.mode_="grid_size",this.model_&&this.model_.forgetEditLine(),this.updateModeIndicators()},this.defaultMode=function(){this.mode_="default",x=void 0,y=void 0,b=void 0,w=void 0,this.model_&&this.model_.forgetEditLine(),this.updateModeIndicators()},this.measuringMode=function(){this.mode_="measuring",x=void 0,y=void 0,b=void 0,w=void 0,this.updateModeIndicators()},this.getMode=function(){return this.mode_},this.gridSizeStarted=function(){return void 0!==x&&void 0!==y},this.startGridSize=function(t,e){x=t,y=e},this.endGridSize=function(t,e){b=t,w=e},this.setGrid=function(){x!==b?y!==w?(T=200/this.canvasWidthToImageWidth(Math.abs(x-b)),M=5/this.canvasHeightToImageHeight(Math.abs(y-w)),this.measuringMode()):alert("Vertical size must be greater than zero"):alert("Horizontal size must be greater than zero")},this.setHorizontalGrid=function(t){T=200/Math.abs(t)},this.setVerticalGrid=function(t){M=5/Math.abs(t)},this.initModelAndController=function(){this.measure_ctx_.font="bold "+W+"px Sans Serif",this.model_=new l,void 0==this.controller_&&(this.controller_=new _(t,this))},this.getUnitsPerPixel=function(){return this.print_factor_},this.setUnitsPerPixel=function(t){this.print_factor_=t},this.setShowDeltas=function(t){this.show_deltas_=t},this.setShowAngles=function(t){this.show_angles_=t},this.getModel=function(){return this.model_},this.getCanvas=function(){return this.measure_canvas_},this.drawAll=function(){this.measure_ctx_.clearRect(0,0,this.measure_canvas_.width,this.measure_canvas_.height),this.drawAllNoClear(this.measure_ctx_)},this.highlightLine=function(t){f(this.measure_ctx_,t,this.show_deltas_,!0)},this.drawAllNoClear=function(t){this.measure_ctx_.font="bold "+W+"px Sans Serif";var e=this.show_deltas_,i=this.model_.getHoveredLineIndex();if(this.model_.forAllLines(function(n,a){var r=!1;a===i&&(r=!0),f(t,n,e,r)}),this.model_.hasEditLine()){var n=this.model_.getEditLine();g(t,n),this.show_deltas_&&p(t,n)}if(this.show_angles_){this.measure_ctx_.font=H+"px Sans Serif";var a=0,r=void 0;this.model_.forAllArcs(function(e){void 0!=r&&r.x==e.center.x&&r.y==e.center.y||(r=e.center,a=0),d(t,e,a++%3*3)})}if("grid_size"===this.mode_&&void 0!==x&&void 0!==y&&void 0!==b&&void 0!==w&&x!==b&&y!==w){t.beginPath(),t.strokeStyle="#f00",t.lineWidth=1,t.lineCap="butt",t.moveTo(x+.5,y+.5),t.lineTo(b+.5,y+.5),t.lineTo(b+.5,w+.5),t.lineTo(x+.5,w+.5),t.closePath(),t.stroke();v(t,"200 ms",(x+b)/2,Math.max(y,w)+12,"center"),v(t,"5 mm",Math.max(x,b)+12,(y+w)/2,"left")}s(t)}}function u(t,e,i){t.moveTo(0,i),t.lineTo(i,i),t.lineTo(i,0),t.moveTo(0,e-i),t.lineTo(i,e-i),t.lineTo(i,e),t.moveTo(e-i,0),t.lineTo(e-i,i),t.lineTo(e,i),t.moveTo(e-i,e),t.lineTo(e-i,e-i),t.lineTo(e,e-i)}function c(t,e,i,n,a){function r(t){return t=A.imageWidthToCanvasWidth(t),t=Math.round(t-.5)+.5}function s(t){return t=A.imageHeightToCanvasHeight(t),t=Math.round(t-.5)+.5}t.beginPath();var o=r(e.p1.x)-i,h=s(e.p1.y)-n,l=r(e.p2.x)-i,d=s(e.p2.y)-n;t.moveTo(o*a,h*a),t.lineTo(l*a,d*a),t.stroke(),t.beginPath(),t.arc(o*a+.5,h*a+.5,1.5*a/2,0,2*Math.PI),t.stroke(),t.beginPath(),t.arc(l*a+.5,d*a+.5,1.5*a/2,0,2*Math.PI),t.stroke()}function g(t,e){if(void 0!==E&&void 0!==M){var i=M.canvas.width,n=x.width,a=t+50;a+i<n?(T.style.left=a+"px",T.style.right="auto"):(T.style.left="auto",T.style.right=n-t+50+"px");var r=x.height,s=e+50;s+i<r?(T.style.top=s+"px",T.style.bottom="auto"):(T.style.top="auto",T.style.bottom=r-e+50+"px");var o=E.width-1,h=E.height-1,l=i/b,d=t-l/2,g=e-l/2,_=0,f=0;d<0&&(_=-d,d=0),g<0&&(f=-g,g=0);var v=t+l/2,p=e+l/2,m=(v=v<o?v:o)-d+1,y=(p=p<h?p:h)-g+1;M.fillStyle="#777",M.fillRect(0,0,i,i);var k=d,I=g,L=v+1,C=p+1;k=k*E.naturalWidth/E.width,I=I*E.naturalHeight/E.height,L=L*E.naturalWidth/E.width,C=C*E.naturalHeight/E.height,_-=.5,f-=.5,M.drawImage(w,k,I,L-k,C-I,_*b,f*b,b*m,b*y),M.beginPath(),M.strokeStyle="rgba(255, 255, 255, 0.3)",M.lineWidth=1;var D=(i-b)/2;u(M,i,D),M.stroke(),M.beginPath(),M.strokeStyle="rgba(0, 0, 0, 0.3)",u(M,i,D-1),M.stroke(),M.beginPath(),M.fillStyle="#000",M.fillText("("+t+","+e+")",10,30),M.stroke();for(var z=t-l/2+.5,W=e-l/2+.5,H=0;H<2;++H){switch(H){case 0:M.strokeStyle=P,M.lineWidth=b;break;case 1:M.strokeStyle=S,M.lineWidth=2}var N=A.getModel();N.forAllLines(function(t){c(M,t,z,W,b)}),N.hasEditLine()&&c(M,N.getEditLine(),z,W,b)}}}function _(t,e){function i(e,i){var n=t.getBoundingClientRect();i(e,e.clientX-n.left,e.clientY-n.top)}function n(){return e.getModel()}function a(){return e}function r(){n().hasEditLine()&&(n().forgetEditLine(),a().drawAll())}function s(t){if(27==t.keyCode)switch(e.getMode()){case"grid_size":e.measuringMode(),e.drawAll();break;default:r()}}function o(t,i,r){if(void 0!==E){if("grid_size"==e.getMode())return e.gridSizeStarted()&&e.endGridSize(i,r),g(i,r),void(e.gridSizeStarted()&&e.drawAll());var s=n().hasEditLine(),o=n().isDragging(),h=!1;s?(n().updateEditLine(i,r),h=!0):o?(n().updateDrag(i,r),h=!0):h=n().updateHoveredLine(i,r),g(i,r),h&&a().drawAll()}}this.start_line_time_=0;var h=this;t.addEventListener("mousedown",function(t){i(t,function(t,e,i){h.onClick(t,e,i)})}),t.addEventListener("mouseup",function(t){i(t,function(t,e,i){h.onMouseUp(t,e,i)})}),t.addEventListener("contextmenu",function(t){t.preventDefault()}),t.addEventListener("mousemove",function(t){i(t,o)}),document.addEventListener("keydown",s),this.onClick=function(t,i,s){var o=e.getMode();if("grid_size"==o)return 3==t.which?(e.measuringMode(),void e.drawAll()):(e.gridSizeStarted()?(e.endGridSize(i,s),e.setGrid()):e.startGridSize(i,s),void e.drawAll());if("default"!==o)if(void 0==t.which||3!=t.which){var h=(new Date).getTime();if(n().hasEditLine()){var l=n().updateEditLine(i,s);l.length()>50||l.length()>0&&h-this.start_line_time_>500?(n().commitEditLine(),k.achievementUnlocked(L.DONE_FINISH_LINE)):n().forgetEditLine()}else n().startEditLine(i,s),this.start_line_time_=h,k.achievementUnlocked(L.DONE_START_LINE);a().drawAll()}else r()},this.onMouseUp=function(t,e,i){n().endDrag(e,i)}}function f(t){for(var e=Object.create(null),i=t.length,n=0;n<i;++n){for(var a=t[n],r=[],s=0,o=0,h=a.length,l=0;l<h;++l){var d=a[l];switch(o){case 0:o=d?2:1;break;case 1:d&&(o=2);break;case 2:d||(o=3,s=1);break;case 3:d?(r.push(s),o=4,s=1):++s;break;case 4:d?++s:(r.push(s),o=3,s=1);break;default:throw new Error}}if(r.length%2==1&&r.pop(),!(r.length<4))for(var u=r.length/2-1,l=0;l<u;++l)(_=""+(_=r[2*l]/2+r[2*l+1]+r[2*l+2]/2))in e?++e[_]:e[_]=1}var c=[],g=0;for(var _ in e)c.push({length:parseFloat(_),count:e[_]}),g+=e[_];if(0===g)throw new Error;c.sort(function(t,e){var i=t.length,n=e.length;return i<n?-1:i>n?1:0});for(var f=Math.round(.38*g),v=Math.round(.62*g),p=c.length,m=0,x=0,l=0;l<p;++l){var y=c[l].length,b=c[l].count;if(v<=m)break;if(m+b<=f);else{var w=0,T=0;m<f&&(w=f-m),v<m+b&&(T=m+b-v),x+=(b-w-T)*y}m+=b}return x/(v-f)}function v(){var i=t(window).height(),n=t(window).width(),a=t(e).height(),r=t(e).width(),s=r/a;a-i>r-n?(t(e).parent().css("height",i-50),t(e).parent().css("width",(i-50)*s)):(t(e).parent().css("width",n-40),t(e).parent().css("height",(n-40)/s))}function p(){v();t(E);var i=t(e).parent().width(),n=t(e).parent().height();t(e).parent().offset();m.css({left:"0px",top:"0px",width:i+"px",height:n+"px"}),i=Math.round(i),n=Math.round(n);var a=m.find(".background-img")[0];a.width=i,a.height=n,a.getContext("2d").drawImage(E,0,0,E.width,E.height),(I=new Image).src=a.toDataURL("image/png");var r=m.find(".measure")[0];r.width=i,r.height=n,T&&(T.style.left=i+10+"px"),A.drawAll()}var m,x,y,b=i.magnification,w=new Image;w.src=e.src;var T,M,k,A,E,I,L={DONE_FILE_LOADING:0,DONE_START_LINE:1,DONE_FINISH_LINE:2,DONE_ADD_ANGLE:3,DONE_SET_LEN:4},S="#00f",P="rgba(255, 255, 0, 0.4)",C=7,D="#f00",z="rgba(0, 255, 255, 0.4)",W=15,H=10,N=5,G=!1;E=e;(m=t('<div style="position: absolute; z-index: 100;"></div>')).append('        <div class="ecg-controls" style="">        <form style="display: inline;">          <button type="button" class="btn btn-xs ecg-zoom-button" style="outline: none;">Zoom</button>          <button type="button" class="btn btn-xs ecg-measure-button" style="outline: none;">Measure</button>          <div class="ecg-controls-2" style="visibility: hidden;">          <button type="button" class="btn btn-xs specify-grid-size-manually" style="outline: none;">Calibrate Distances</button>    \t  <button type="button" class="btn btn-xs ecg-clear-button" style="outline: none;">Clear</button>    \t\t<span class="helptext" style="padding-left: 1em; font-weight: bold;"></span>          </div>        </form>        </div>        <canvas class="background-img" width="50" height="50" style="position: absolute; left: 0; top: 0; background: transparent; z-index: 10; visibility: hidden;"></canvas>        <canvas class="measure" width="50" height="50" style="position: absolute; left: 0; top: 0; background: transparent; z-index: 20;"></canvas>        <canvas class="loupe" width="280" height="280" style="position: absolute; left: 50%; top: 50%; background: transparent; z-index: 30; display: none; box-shadow: 3px 3px 15px; border-radius: 10px; color: #000;"></canvas>      '),t(E).parent().append(m),y=m.find(".background-img"),x=y[0],m.find(".ecg-zoom-button").click(function(){var e=t(this);e.hasClass("active")?e.removeClass("active"):e.addClass("active"),A.updateModeIndicators(),A.drawAll()}),m.find(".ecg-measure-button").click(function(){switch(A.getMode()){case"measuring":A.defaultMode();break;case"grid_size":case"default":A.measuringMode(),1==G&&alert("Cannot detect ECG grid to calibrate measurements, use the 'Calibrate' button and draw a box around the large grid box (200ms by 5mm [0.5mV])")}A.drawAll()}),m.find(".specify-grid-size-manually").click(function(t){switch(A.getMode()){case"grid_size":A.defaultMode();break;case"measuring":case"default":A.gridSizeMode()}A.drawAll()}),m.find(".ecg-clear-button").click(function(){A.model_.removeAllLines(),A.measuringMode(),A.drawAll()}),function(t,e){var i=m.find(".helptext");k=new n(i[0]);var a=m.find(".measure");(A=new d(a[0],t,e)).defaultMode();var r=m.find(".loupe"),s=(T=r[0]).width,o=Math.round(s/b)*b;T.width=o,T.height=o,T.style.left=document.body.clientWidth-T.width-10+"px",M=T.getContext("2d"),A.initModelAndController()}(e.naturalWidth,e.naturalHeight);t(E);t(window).resize(function(){p()}),new MutationObserver(function(t){p()}).observe(document,{childList:!0}),p();var O=document.createElement("canvas");O.width=e.naturalWidth,O.height=e.naturalHeight;var B=O.getContext("2d");B.drawImage(e,0,0,e.naturalWidth,e.naturalHeight),function(e,i){for(var n=i.getImageData(0,0,e.width,e.height),a=n.width,r=n.height,s=n.data,o=(s.length,Math.round(a/4)),h=Math.round(3*a/4),l=Math.round(r/4),d=Math.round(3*r/4),u=l;u<=d;++u)for(T=o;T<=h;++T){var c=s[L=4*(u*a+T)],g=s[L+1],_=s[L+2],v=Math.round(.299*c+.587*g+.114*_);s[L]=s[L+1]=s[L+2]=v}try{for(var p=0,m=0,u=l;u<=d;++u)for(T=o;T<=h;++T){var x;(c=s[L=4*(u*a+T)])<242.5?(x=0,++m):(x=255,++p),s[L]=s[L+1]=s[L+2]=x}if(0===p||0===m)throw new Error;var y=p/(p+m);if(y<.3||y>.9)throw new Error;for(var b=[],u=l;u<=d;++u){for(var w=[],T=o;T<=h;++T)I=0!==(c=s[L=4*(u*a+T)]),w.push(I);b.push(w)}for(var M=f(b),k=[],T=o;T<=h;++T){for(var E=[],u=l;u<=d;++u){var I,L=4*(u*a+T);I=0!==(c=s[L]),E.push(I)}k.push(E)}var S=f(k);A.setHorizontalGrid(5*M),A.setVerticalGrid(5*S)}catch(e){if(t.fn.measurements.alerted)return;G=!0,t.fn.measurements.alerted=!0}}(O,B);var U=e.src,R=/[^/]+$/.exec(U);if(R)R[0];A.drawAll()}t.fn.measurements=function(i){var n=t.extend({magnification:6},i);this.each(function(){this.complete?e(this,n):this.addEventListener("load",function(){e(this,n)})})}}(jQuery);